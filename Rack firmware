#include <Wire.h>
#include <SparkFun_APDS9960.h> // APDS-9960 ë¼ì´ë¸ŒëŸ¬ë¦¬
#include <AccelStepper.h>       // AccelStepper ë¼ì´ë¸ŒëŸ¬ë¦¬

// --- 1. APDS-9960 í•€ ë° ê°ì²´ ì„¤ì • ---
SparkFun_APDS9960 apds = SparkFun_APDS9960();

// --- ìƒ‰ìƒ ê°ì§€ë¥¼ ìœ„í•œ ë¹„ë¡€ ìƒìˆ˜ ì„¤ì • ---
const float FACTOR_RGB = 1.15;   // ê¸°ì¤€ ìœ ì§€
const float MIN_COLOR_VALUE = 10.0; // ìœ íš¨ì„± ê²€ì‚¬ ê¸°ì¤€ ìœ ì§€


// --- 2. ìŠ¤í…Œí¼ ëª¨í„° í•€ ë° ê°ì²´ ì„¤ì • ---
#define X_STEP_PIN 2
#define X_DIR_PIN 5
AccelStepper stepperX(AccelStepper::DRIVER, X_STEP_PIN, X_DIR_PIN);

#define A_STEP_PIN 22
#define A_DIR_PIN 23
AccelStepper stepperA(AccelStepper::DRIVER, A_STEP_PIN, A_DIR_PIN); 

#define Y_STEP_PIN 3
#define Y_DIR_PIN 6
AccelStepper stepperY(AccelStepper::DRIVER, Y_STEP_PIN, Y_DIR_PIN);

#define Z_STEP_PIN 4
#define Z_DIR_PIN 7
AccelStepper stepperZ(AccelStepper::DRIVER, Z_STEP_PIN, Z_DIR_PIN);

// --- 3. ì ì™¸ì„  ì„¼ì„œ í•€ ì„¤ì • (48, 49ë²ˆ) ---
#define IR_SENSOR_LEFT_PIN 48
#define IR_SENSOR_RIGHT_PIN 49


// --- 4. ì´ë™ ìŠ¤í… ìˆ˜ ì„¤ì • ---
/* Yì¶• ê¸°ë³¸ ì´ë™ ìŠ¤í… ìˆ˜ (2500)*/
const long Y_MOVE_STEPS = 10; 
/* Xì¶• ìƒ‰ìƒë³„ ìŠ¤í… ìˆ˜ */
const long X_RED_STEPS =30;
const long X_GREEN_STEPS = 800;
const long X_BLUE_STEPS = 1450;
/*Zì¶• ì´ë™ ìŠ¤í… ìˆ˜*/
const long Z_MOVE_STEPS = 2500;

// ëª¨í„° ì†ë„ ì„¤ì • 
#define MAX_SPEED 1000.0 
#define ACCELERATION 1000.0 

// --- 5. ë³€ìˆ˜ ì„¤ì • ---
uint16_t red_data = 0;
uint16_t green_data = 0;
uint16_t blue_data = 0;
uint16_t ambient_light = 0; 

// --- ë³´ì¡° í•¨ìˆ˜ í”„ë¡œí† íƒ€ì… ---
bool isRedColor(uint16_t r, uint16_t g, uint16_t b);
bool isGreenColor(uint16_t r, uint16_t g, uint16_t b);
bool isBlueColor(uint16_t r, uint16_t g, uint16_t b);
long getIRMoveSteps(); 
int getIRCode(); 
void runSingleMotorToPosition(AccelStepper& stepper, const char* axisName);
void runTwoMotorsToPosition(AccelStepper& stepper1, AccelStepper& stepper2, const char* axisName1, const char* axisName2);
void checkAndMoveAxis(long xSteps, const char* color, const char* colorCode, int irCode);


// --- Setup ---
void setup() {
  Serial.begin(9600); 
  Serial.println("âœ¨ 3ì¶• R/G/B ë° IR ì„¼ì„œ ì—°ë™ ì‹œìŠ¤í…œ ì‹œì‘ (ìµœì¢… ì¶œë ¥: D1/E2/F3)");

  // APDS-9960 ì´ˆê¸°í™”
  if (!apds.init()) {
    Serial.println("âŒ APDS-9960 ì´ˆê¸°í™” ì‹¤íŒ¨! ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
  } else {
    apds.enableLightSensor(false);
    Serial.println("âœ… APDS-9960 ì´ˆê¸°í™” ë° ì»¬ëŸ¬ ì„¼ì„œ í™œì„±í™” ì„±ê³µ.");
  }

  // IR ì„¼ì„œ í•€ ì„¤ì •
  pinMode(IR_SENSOR_LEFT_PIN, INPUT_PULLUP); 
  pinMode(IR_SENSOR_RIGHT_PIN, INPUT_PULLUP);

  // ëª¨í„° ì„¤ì •
  stepperX.setMaxSpeed(MAX_SPEED);
  stepperX.setAcceleration(ACCELERATION);
  
  stepperA.setMaxSpeed(MAX_SPEED);
  stepperA.setAcceleration(ACCELERATION);
 
  stepperY.setMaxSpeed(MAX_SPEED);
  stepperY.setAcceleration(ACCELERATION);
  
  stepperZ.setMaxSpeed(MAX_SPEED);
  stepperZ.setAcceleration(ACCELERATION);

  Serial.println("ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ. R/G/B ê°ì§€ ëŒ€ê¸° ì¤‘...");
}

// --- Loop ---
void loop() {
  
  if (apds.readAmbientLight(ambient_light) &&
      apds.readRedLight(red_data) &&
      apds.readGreenLight(green_data) &&
      apds.readBlueLight(blue_data)) {

    // --- Green ê°’ ì¡°ì • (-10) ---
    uint16_t adjusted_green_data = (green_data > 10) ? (green_data - 10) : 0;
    
    // --- IR ì„¼ì„œ ê°’ ì½ê¸° ë° ì½”ë“œ ê³„ì‚° ---
    int irLeft = digitalRead(IR_SENSOR_LEFT_PIN);
    int irRight = digitalRead(IR_SENSOR_RIGHT_PIN);
    int irCode = getIRCode(); // 1: ë¯¸ê°ì§€, 2: 1ê°œ ê°ì§€, 3: 2ê°œ ê°ì§€

    // --- ì‹œë¦¬ì–¼ ëª¨ë‹ˆí„° ì¶œë ¥ (R/G/B, IR ìƒíƒœ) ---
    Serial.print("Ambient: "); Serial.print(ambient_light);
    Serial.print(" | R: "); Serial.print(red_data);
    Serial.print(" G(Adj): "); Serial.print(adjusted_green_data); 
    Serial.print(" B: "); Serial.print(blue_data);
    
    // IR ì„¼ì„œ ìƒíƒœ ì¶œë ¥ (H/L)
    Serial.print(" | IR 1:"); Serial.print(irLeft == HIGH ? "H" : "L"); 
    Serial.print(" 2:"); Serial.print(irRight == HIGH ? "H" : "L"); 
    
    // --- R, G, B ìƒ‰ìƒ ê°ì§€ ë° ë™ì‘ ë¡œì§ ---
    if (isRedColor(red_data, adjusted_green_data, blue_data)) {
      // ğŸš© ìµœì¢… ì¶œë ¥ í¬ë§·: D + IR ì½”ë“œ (ì˜ˆ: D1)
      Serial.print(" | Detected: **D"); Serial.print(irCode); Serial.println("**");
      checkAndMoveAxis(X_RED_STEPS, "RED", "D", irCode); 
    } 
    else if (isGreenColor(red_data, adjusted_green_data, blue_data)) {
      // ğŸš© ìµœì¢… ì¶œë ¥ í¬ë§·: E + IR ì½”ë“œ (ì˜ˆ: E2)
      Serial.print(" | Detected: **E"); Serial.print(irCode); Serial.println("**");
      checkAndMoveAxis(X_GREEN_STEPS, "GREEN", "E", irCode);
    }
    else if (isBlueColor(red_data, adjusted_green_data, blue_data)) {
      // ğŸš© ìµœì¢… ì¶œë ¥ í¬ë§·: F + IR ì½”ë“œ (ì˜ˆ: F3)
      Serial.print(" | Detected: **F"); Serial.print(irCode); Serial.println("**");
      checkAndMoveAxis(X_BLUE_STEPS, "BLUE", "F", irCode);
    }
    else {
      Serial.println(" | Detected: None"); // ê°ì§€ëœ ìƒ‰ìƒ ì—†ìŒ
    }
  }
  
  delay(500); // ì„¼ì„œ ì½ê¸° ì£¼ê¸°
}

// --- ë³´ì¡° í•¨ìˆ˜ (IR ì„¼ì„œ ì½”ë“œ ë°˜í™˜) ---
// 1: ê²€ì€ìƒ‰ ë¯¸ê°ì§€ (IR=HIGH), 2: 1ê°œ ê°ì§€, 3: 2ê°œ ê°ì§€ (IR=LOW)
int getIRCode() {
    delay(500);
    int irLeft = digitalRead(IR_SENSOR_LEFT_PIN);
    int irRight = digitalRead(IR_SENSOR_RIGHT_PIN);
    
    // LOWê°€ ê²€ì€ìƒ‰ ê°ì§€ (í¡ìˆ˜)
    if (irLeft == LOW && irRight == LOW) {
      return 3; // ë‘˜ ë‹¤ ê²€ì€ìƒ‰ ê°ì§€
    } else if (irLeft == LOW || irRight == LOW) {
        return 2; // í•˜ë‚˜ë§Œ ê²€ì€ìƒ‰ ê°ì§€
    } else {
        return 1; // ë‘˜ ë‹¤ ê²€ì€ìƒ‰ ë¯¸ê°ì§€ (HIGH)
    }
}

// --- ë³´ì¡° í•¨ìˆ˜ (IR ì„¼ì„œ ìŠ¤í… ê³„ì‚°) ---
long getIRMoveSteps() {
    int irCode = getIRCode();
    long addedSteps = 0;

    if (irCode == 3) {
        addedSteps = 6000;
    } else if (irCode == 2) {
        addedSteps = 3000;
    } else {
        addedSteps = 0;
    }
    return addedSteps;
}

// --- ë³´ì¡° í•¨ìˆ˜ (ì»¬ëŸ¬ ë¡œì§ - FACTOR_RGB = 1.5) ---
bool isRedColor(uint16_t r, uint16_t g, uint16_t b) {
  if (r < MIN_COLOR_VALUE || g < MIN_COLOR_VALUE || b < MIN_COLOR_VALUE) return false;
  
  if ((float)r > (float)g * FACTOR_RGB && (float)r > (float)b * FACTOR_RGB) return true;
  return false;
}

bool isGreenColor(uint16_t r, uint16_t g, uint16_t b) {
  if (r < MIN_COLOR_VALUE || g < MIN_COLOR_VALUE || b < MIN_COLOR_VALUE) return false;

  // 1. ì¼ë°˜ì ì¸ Green ê°ì§€ ì¡°ê±´ (Gê°€ R, Bë³´ë‹¤ FACTOR_RGB(1.5)ë°° ì´ìƒ ì»¤ì•¼ í•¨)
  if ((float)g > (float)r * FACTOR_RGB && (float)g > (float)b * FACTOR_RGB) {
    
    // 2. ì¶”ê°€ëœ ë¡œì§: Gê°€ Bë³´ë‹¤ 100 ì´ë‚´ë¡œ í¬ë©´ Greenìœ¼ë¡œ ì¸ì‹í•˜ì§€ ì•Šê³  false (Blueë¡œ ë„˜ì–´ê°)
    // G > B ì´ê³ , G - B <= 100 ì´ë©´ Blueë¡œ ì¸ì‹í•˜ê²Œ í•˜ê¸° ìœ„í•¨.
    // ì°¸ê³ : uint16_tëŠ” í•­ìƒ ì–‘ìˆ˜ì´ë¯€ë¡œ, Gê°€ Bë³´ë‹¤ í¬ë‹¤ëŠ” ì¡°ê±´ì€ (g - b) <= 150ì— ë‚´í¬ë¨.
    /*if (g > b && (g - b) <= 150) {
      return false; // Blueë¡œ ì¸ì‹ì´ ë„˜ì–´ê°€ë„ë¡ false ë°˜í™˜
    }*/

    // 3. ìœ„ì˜ ì˜ˆì™¸ ì¡°ê±´ì— ê±¸ë¦¬ì§€ ì•Šì€ ìˆœìˆ˜í•œ Green
    return true; 
  }
  
  return false;
}

bool isBlueColor(uint16_t r, uint16_t g, uint16_t b) {
  if (r < MIN_COLOR_VALUE || g < MIN_COLOR_VALUE || b < MIN_COLOR_VALUE) return false;

  if ((float)b > (float)r * FACTOR_RGB && (float)b > (float)g * FACTOR_RGB) return true;
  return false;
}


// --- ë³´ì¡° í•¨ìˆ˜ (ë‹¨ì¼ ëª¨í„° ì œì–´) ---
void runSingleMotorToPosition(AccelStepper& stepper, const char* axisName) {
  while (stepper.distanceToGo() != 0) {
    stepper.run();
  }
  Serial.print("      - ");
  Serial.print(axisName);
  Serial.println(" ì¶• ì™„ë£Œ.");
}

// --- ë³´ì¡° í•¨ìˆ˜ (Yì¶• ë° Aì¶• ë™ì‹œ ì œì–´) ---
void runTwoMotorsToPosition(AccelStepper& stepper1, AccelStepper& stepper2, const char* axisName1, const char* axisName2) {
  // ë‘ ëª¨í„° ì¤‘ í•˜ë‚˜ë¼ë„ ì›€ì§ì¼ ê±°ë¦¬ê°€ ë‚¨ì•„ìˆë‹¤ë©´ ê³„ì† ì‹¤í–‰
  while (stepper1.distanceToGo() != 0 || stepper2.distanceToGo() != 0) { 
    stepper1.run();
    stepper2.run();
  }
  Serial.print("      - ");
  Serial.print(axisName1);
  Serial.print("/");
  Serial.print(axisName2);
  Serial.println(" ì¶• ì™„ë£Œ.");
}


/** ìƒ‰ìƒë³„ Xì¶• ì´ë™ ë° ëª¨ë“  ì¶• ìˆœì°¨ ë³µê·€ë¥¼ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜ */
void checkAndMoveAxis(long xSteps, const char* color, const char* colorCode, int irCode) {
  
  // IR ì„¼ì„œ ìƒíƒœì— ë”°ë¥¸ Yì¶• ì¶”ê°€ ìŠ¤í… ê³„ì‚°
  long irAddedSteps = getIRMoveSteps();
  // Yì¶•ì˜ ìµœì¢… ì´ë™ ìŠ¤í…: ê¸°ë³¸ ìŠ¤í… + IR ì¶”ê°€ ìŠ¤í…
  long totalYSteps = Y_MOVE_STEPS + irAddedSteps;

  // =========================================================
  // 1ë‹¨ê³„: X, Y/A, Z ì¶• ìˆœì°¨ ì´ë™ 
  // =========================================================
  Serial.print("    [MOVE] Final Code: "); Serial.print(colorCode); Serial.print(irCode); 
  Serial.print(" | "); Serial.print(color); Serial.println(" ì´ë™ ì‹œì‘.");
  
  // ì´ë™í•  ìŠ¤í… ê°’ ì¶œë ¥
  Serial.print("    > 1ë‹¨ê³„: X("); Serial.print(xSteps); 
  Serial.print(") -> Y/A("); Serial.print(totalYSteps); 
  Serial.print(") -> Z("); Serial.print(Z_MOVE_STEPS); Serial.println(") ìˆœì°¨ ì •ë°©í–¥ ì´ë™ ì¤‘...");

  // Xì¶• ì´ë™ (ë‹¨ì¼)
  stepperX.move(xSteps);
  runSingleMotorToPosition(stepperX, "X"); 

  // Yì¶• ë° Aì¶• ë™ì‹œ ì´ë™
  stepperY.move(totalYSteps);
  stepperA.move(totalYSteps); 
  runTwoMotorsToPosition(stepperY, stepperA, "Y", "A"); 

  // Zì¶• ì´ë™ (ë‹¨ì¼)
  stepperZ.move(Z_MOVE_STEPS);
  runSingleMotorToPosition(stepperZ, "Z");
  
  Serial.print("    > 1ë‹¨ê³„: "); Serial.print(color); Serial.println(" ì´ë™ ì™„ë£Œ.");

  // ğŸš© 3ì´ˆ ëŒ€ê¸° 
  Serial.println("    *** 3ì´ˆ(3000ms) ëŒ€ê¸° í›„ ì›ìƒ ë³µê·€ ì‹œì‘... ***");
  delay(3000); 

  // =========================================================
  // 2ë‹¨ê³„: Z, Y/A, X ì¶• ìˆœì°¨ ë³µê·€ 
  // =========================================================
  Serial.println("    > 2ë‹¨ê³„: Z -> Y/A -> X ìˆœì°¨ ì—­ë°©í–¥ ë³µê·€ ì¤‘...");
  
  // Zì¶• ë³µê·€ (ë‹¨ì¼)
  stepperZ.move(-Z_MOVE_STEPS); 
  runSingleMotorToPosition(stepperZ, "Z");

  // Yì¶• ë° Aì¶• ë™ì‹œ ë³µê·€
  stepperY.move(-totalYSteps);
  stepperA.move(-totalYSteps);
  runTwoMotorsToPosition(stepperY, stepperA, "Y", "A"); 

  // Xì¶• ë³µê·€ (ë‹¨ì¼)
  stepperX.move(-xSteps);
  runSingleMotorToPosition(stepperX, "X");
  
  Serial.println("    > 2ë‹¨ê³„: **ëª¨ë“  ì¶• ì›ìƒ ë³µê·€ ì™„ë£Œ!**");
}
